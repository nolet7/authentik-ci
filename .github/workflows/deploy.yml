name: CD - Deploy Authentik via Helm

on:
  push:
    branches:
      - master
    paths:
      - helm/**
      - .github/workflows/deploy.yml

jobs:
  deploy-authentik:
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Vault CLI
        run: |
          sudo curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install vault -y

      - name: Authenticate to Vault
        run: vault login ${{ secrets.VAULT_TOKEN }}
        env:
          VAULT_ADDR: http://192.168.0.116:8200

      - name: Export Vault Secrets to ENV
        run: |
          echo "VAULT_SECRET_KEY=$(vault kv get -field=AUTHENTIK_SECRET_KEY secret/Dev-secret/authentik)" >> $GITHUB_ENV
        env:
          VAULT_ADDR: http://192.168.0.116:8200

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Helm Dependency Update (if needed)
        run: helm dependency update ./helm

      - name: Helm Upgrade --install
        run: |
          helm upgrade --install authentik ./helm \
            --namespace authentik \
            --create-namespace \
            --set-string vault.role=authentik-role \
            --set-string vault.secretPath=secret/Dev-secret/authentik \
            --values helm/values.yaml

